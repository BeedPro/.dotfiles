#!/bin/bash

sudo apt update
sudo apt install libfuse2

# Configuration
DOWNLOAD_URL="https://api.beeper.com/desktop/download/linux/x64/stable/com.automattic.beeper.desktop"
TEMP_DIR="/tmp/beeper"
INSTALL_PATH="/opt/beeper.AppImage"
ICON_DEST="/usr/share/icons/hicolor/512x512/apps/beepertexts.png"
DESKTOP_ENTRY="/usr/local/share/applications/beepertexts.desktop"

echo "Step 1: Downloading Beeper AppImage..."
mkdir -p "$TEMP_DIR"
cd "$TEMP_DIR" || exit 1

wget -O Beeper.AppImage "$DOWNLOAD_URL"
chmod a+x Beeper.AppImage

echo "Step 2: Extracting icon..."
# Extract files to get the icon without running the app
./Beeper.AppImage --appimage-extract > /dev/null

echo "Step 3: Installing files to system..."
# Move AppImage to /opt
sudo mv Beeper.AppImage "$INSTALL_PATH"

# Ensure icon directory exists and copy icon
sudo mkdir -p "$(dirname "$ICON_DEST")"
sudo cp squashfs-root/usr/share/icons/hicolor/512x512/apps/beepertexts.png "$ICON_DEST"

# Create symlink
sudo ln -sf "$INSTALL_PATH" /usr/local/bin/beeper

echo "Step 4: Creating Desktop Entry..."
sudo tee "$DESKTOP_ENTRY" > /dev/null <<EOF
[Desktop Entry]
Name=Beeper
Exec=beeper --no-sandbox %U
Terminal=false
Type=Application
Icon=beepertexts
StartupWMClass=Beeper
Comment=The ultimate messaging app
MimeType=x-scheme-handler/beeper;
Categories=Network;
EOF

# Set permissions
sudo chmod 644 "$DESKTOP_ENTRY"

# Update desktop database
if command -v update-desktop-database &> /dev/null; then
    sudo update-desktop-database /usr/local/share/applications
fi

echo "Step 5: Cleaning up..."
rm -rf "$TEMP_DIR"

echo "------------------------------------------------"
echo "Beeper installation complete!"
