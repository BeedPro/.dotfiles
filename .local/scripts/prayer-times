#!/usr/bin/env python3
import os
import json
from urllib.request import urlopen
from urllib.parse import urlencode
from datetime import datetime, timedelta

CACHE_FILE = "/tmp/prayer-times.json"


def fetch_prayer_times():
    date_str = datetime.now().strftime("%d-%m-%Y")

    base_url = f"https://api.aladhan.com/v1/timings/{date_str}"
    params = {
        "latitude": 51.5074,
        "longitude": -0.1278,
        "method": 2,
        "timezonestring": "Europe/London",
    }

    full_url = f"{base_url}?{urlencode(params)}"

    with urlopen(full_url, timeout=10) as response:
        return json.loads(response.read().decode())


def load_prayer_times():
    today = datetime.now().strftime("%d-%m-%Y")

    if os.path.exists(CACHE_FILE):
        try:
            with open(CACHE_FILE, "r") as f:
                cached_data = json.load(f)

            cached_date = (
                cached_data.get("data", {})
                .get("date", {})
                .get("gregorian", {})
                .get("date")
            )

            if cached_date == today:
                return cached_data
        except Exception:
            pass

    data = fetch_prayer_times()

    if data.get("code") == 200:
        try:
            with open(CACHE_FILE, "w") as f:
                json.dump(data, f)
        except Exception:
            pass
        return data

    raise Exception("API error")


def parse_time_today(time_str):
    now = datetime.now()
    clean_time = time_str.split(" ")[0]
    return datetime.strptime(clean_time, "%H:%M").replace(
        year=now.year, month=now.month, day=now.day
    )


def get_current_and_next(timings):
    now = datetime.now()
    order = ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"]

    parsed = [(name, parse_time_today(timings[name])) for name in order]

    for i, (name, t) in enumerate(parsed):
        if now < t:
            if i > 0:
                current_name = parsed[i - 1][0]
                current_time = timings[current_name].split(" ")[0]
            else:
                current_name = "Isha"
                current_time = timings["Isha"].split(" ")[0]

            next_name = name
            next_time = timings[name].split(" ")[0]

            return current_name, current_time, next_name, next_time

    # After Isha → current = Isha, next = tomorrow Fajr
    current_name = "Isha"
    current_time = timings["Isha"].split(" ")[0]

    fajr_time = parse_time_today(timings["Fajr"]) + timedelta(days=1)
    next_name = "Fajr"
    next_time = fajr_time.strftime("%H:%M")

    return current_name, current_time, next_name, next_time


def main():
    try:
        data = load_prayer_times()
        timings = data["data"]["timings"]

        current_name, current_time, next_name, next_time = get_current_and_next(timings)
        print(f"󰽥 {current_name} ({next_name} {next_time})")

    except Exception:
        print("Prayer --")


if __name__ == "__main__":
    main()
