#!/usr/bin/env bash
set -euo pipefail

# Dependencies check
command -v pactl >/dev/null 2>&1 || { echo "pactl not found. Install PulseAudio/PipeWire tools."; exit 1; }
command -v dmenu >/dev/null 2>&1 || { echo "dmenu not found. Install dmenu."; exit 1; }

# Get default sink name
default_sink=$(pactl get-default-sink)

# Collect sinks and descriptions
mapfile -t sinks < <(pactl list sinks short | awk '{print $2}')
declare -A descs

for sink in "${sinks[@]}"; do
  desc=$(pactl list sinks | awk -v s="$sink" '
    $0 ~ "Name: "s {found=1}
    found && /Description:/ {sub(/^[ \t]*Description: /, ""); print; exit}
  ')
  # Mark the default sink
  if [[ "$sink" == "$default_sink" ]]; then
    descs["* $desc"]="$sink"
  else
    descs["$desc"]="$sink"
  fi
done

# Show menu (default on top)
choice=$(printf "%s\n" "${!descs[@]}" | LC_ALL=C sort | awk '/^\*/{print;next}{print}' | dmenu -i -p "Audio output") || exit 1
[ -z "$choice" ] && exit 1

# Remove the star if present
clean_choice="${choice#* }"
sink_name="${descs[$choice]}"

# Switch default sink
pactl set-default-sink "$sink_name"

# Move all active streams
while read -r input_id _; do
  [ -n "$input_id" ] && pactl move-sink-input "$input_id" "$sink_name"
done < <(pactl list short sink-inputs 2>/dev/null)

# Notify if available
command -v notify-send >/dev/null 2>&1 && notify-send "Audio output switched" "$clean_choice"
