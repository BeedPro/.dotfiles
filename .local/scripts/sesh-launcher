#!/usr/bin/env python3

from __future__ import annotations

import os
import subprocess
import sys
from pathlib import Path
from subprocess import CompletedProcess, Popen
from typing import Iterable, List, Dict, Tuple

SRC_DIR: Path = Path.home() / ".local" / "src"
SRC_DIR.mkdir(parents=True, exist_ok=True)

TMUX_ICON: str = "@"
CONFIG_ICON: str = "+"


def run(cmd: list[str], **kwargs) -> CompletedProcess[str]:
    return subprocess.run(cmd, check=True, text=True, **kwargs)


def is_valid_base(path: Path) -> bool:
    return path.is_dir()


def relative_depth(root: str, base_depth: int) -> int:
    return len(Path(root).parts) - base_depth


def handle_depth(
    root: str,
    dirs: List[str],
    current: int,
    target: int,
    base: Path,
    result: List[str],
) -> None:
    if current > target:
        dirs.clear()
        return

    if current == target:
        rel: Path = Path(root).resolve().relative_to(base)
        result.append(rel.as_posix())
        dirs.clear()


def find_dirs(input: str, depth: int = 1) -> List[str]:
    base: Path = Path(input).expanduser().resolve()
    if not is_valid_base(base):
        return []

    result: List[str] = []
    base_depth: int = len(base.parts)

    for root, dirs, _ in os.walk(base):
        current: int = relative_depth(root, base_depth)
        handle_depth(root, dirs, current, depth, base, result)

    return result


def add_paths(
    out: Dict[str, str],
    items: Iterable[str],
    prefix: str,
    base: str,
) -> None:
    for p in items:
        key: str = f"{prefix}{p}" if prefix else p
        out[key] = f"{base}/{p}"


def create_mapping(paths: list[str]) -> Dict[str, str]:
    src: List[str] = find_dirs(paths[0], 2)
    config: List[str] = find_dirs(paths[1])

    out: Dict[str, str] = {
        "agim": "~/Compendium/Agenda",
        "slipbox": "~/Compendium/Slipbox",
        "workspace": "~/Compendium/Workspace",
        "dotfiles": "~/.dotfiles",
        "scripts": "~/.local/scripts",
    }

    add_paths(out, src, "", paths[0])
    add_paths(out, config, "config/", paths[1])

    return out


def get_tmux_items() -> List[str]:
    try:
        out: str = subprocess.check_output(
            ["tmux", "list-sessions", "-F", "#S"],
            stderr=subprocess.DEVNULL,
            text=True,
        )
        return out.splitlines()
    except subprocess.CalledProcessError:
        return []


def get_all_items(paths: list[str]) -> Tuple[List[str], Dict[str, str]]:
    mapping: dict[str, str] = create_mapping(paths)

    tmux: set[str] = set(get_tmux_items())
    keys: set[str] = set(mapping)

    display: List[str] = []

    for name in sorted(tmux):
        display.append(f"{TMUX_ICON} {name}")

    for name in sorted(keys - tmux):
        display.append(f"{CONFIG_ICON} {name}")

    return display, mapping


def fzf_select(items: List[str]) -> str:
    cmd: list[str] = [
        "fzf",
        "--prompt",
        "> ",
        "--reverse",
        "--height=100%",
        "--print-query",
        "--color=bg:-1,bg+:-1,preview-bg:-1",
    ]

    p: Popen[str] = subprocess.Popen(
        cmd,
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        text=True,
    )

    stdout, _ = p.communicate("\n".join(items))
    return stdout.strip()


def ensure_session(name: str, directory: Path) -> None:
    inside_tmux: bool = "TMUX" in os.environ

    if (
        subprocess.run(
            ["tmux", "has-session", "-t", name],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
        ).returncode
        != 0
    ):
        run(
            [
                "tmux",
                "new-session",
                "-ds",
                name,
                "-c",
                str(directory.expanduser().resolve()),
            ]
        )

    if inside_tmux:
        run(["tmux", "switch-client", "-t", name])
    else:
        run(["tmux", "attach-session", "-t", name])


def main() -> None:
    paths: list[str] = [
        "~/.local/src",
        "~/.dotfiles/.config",
    ]

    items, mapping = get_all_items(paths)
    selected: str = fzf_select(items)[2:]

    if not selected:
        return

    if selected in mapping:
        ensure_session(selected, Path(mapping[selected]))
    else:
        ensure_session(selected, Path("~"))


if __name__ == "__main__":
    try:
        main()
    except subprocess.CalledProcessError as e:
        sys.exit(e.returncode)
