#!/usr/bin/env python3

import os
import subprocess
import sys
from pathlib import Path

SRC_DIR = Path.home() / ".local" / "src"
SRC_DIR.mkdir(parents=True, exist_ok=True)


def run(cmd, **kwargs):
    return subprocess.run(cmd, check=True, text=True, **kwargs)


def is_valid_base(path: Path) -> bool:
    return path.is_dir()


def relative_depth(root: str, base_depth: int) -> int:
    return len(Path(root).parts) - base_depth


def handle_depth(root, dirs, current, target, base, result):
    if current > target:
        dirs.clear()
        return

    if current == target:
        rel = Path(root).resolve().relative_to(base)
        result.append(rel.as_posix())
        dirs.clear()


def find_dirs(input: str, depth: int = 1) -> list[str]:
    base = Path(input).expanduser().resolve()
    if not is_valid_base(base):
        return []

    result = []
    base_depth = len(base.parts)

    for root, dirs, _ in os.walk(base):
        current = relative_depth(root, base_depth)
        handle_depth(root, dirs, current, depth, base, result)

    return result


def add_paths(out, items, prefix, base):
    for p in items:
        key = f"{prefix}{p}" if prefix else p
        out[key] = f"{base}/{p}"


def create_mapping(paths):
    src = find_dirs(paths[0], 2)
    share = find_dirs(paths[1])
    config = find_dirs(paths[2])

    out = {"agenda": "~/Compendium/Agenda"}
    add_paths(out, src, "", paths[0])
    add_paths(out, share, "share/", paths[1])
    add_paths(out, config, "config/", paths[2])
    return out


def get_tmux_items():
    try:
        out = subprocess.check_output(
            ["tmux", "list-sessions", "-F", "#S"],
            stderr=subprocess.DEVNULL,
            text=True,
        )
        return out.splitlines()
    except subprocess.CalledProcessError:
        return []


def get_sesh_items():
    return subprocess.check_output(["sesh", "list", "-c"], text=True).splitlines()


def get_all_items(paths):
    mapping = create_mapping(paths)

    sesh = set(get_sesh_items())
    tmux = set(get_tmux_items())
    keys = set(mapping)

    display = []

    for name in sorted(tmux):
        display.append(f"{name}")

    for name in sorted(sesh - tmux):
        display.append(f"{name}")

    for name in sorted(keys - sesh - tmux):
        display.append(f"{name}")

    return display, mapping


def fzf_select(items):
    cmd = [
        "fzf",
        "--prompt",
        "> ",
        "--reverse",
        "--exit-0",
        "--color=bg:-1,bg+:-1,preview-bg:-1",
    ]

    p = subprocess.Popen(
        cmd,
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        text=True,
    )

    stdout, _ = p.communicate("\n".join(items))
    return stdout.strip()


def ensure_session(name: str, directory: Path):
    if (
        subprocess.run(
            ["tmux", "has-session", "-t", name],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
        ).returncode
        != 0
    ):
        run(
            [
                "tmux",
                "new-session",
                "-ds",
                name,
                "-c",
                str(directory.expanduser().resolve()),
            ]
        )

    run(["tmux", "switch-client", "-t", name])


def main():
    paths = [
        "~/.local/src",
        "~/.dotfiles/.local/share",
        "~/.dotfiles/.config",
    ]

    items, mapping = get_all_items(paths)
    selected = fzf_select(items)

    if not selected:
        return

    # Strip icon + space
    # selected = selected[2:]

    if selected in mapping:
        ensure_session(selected, Path(mapping[selected]))
    else:
        run(["sesh", "connect", selected])


if __name__ == "__main__":
    try:
        main()
    except subprocess.CalledProcessError as e:
        sys.exit(e.returncode)
