#!/usr/bin/env python3

import re
import curses
import subprocess
import sys
from pathlib import Path

SRC_DIR = Path.home() / ".local" / "src"
SRC_DIR.mkdir(parents=True, exist_ok=True)

EXIT_SIGNAL = "__ESC_EXIT__"


def is_esc(ch: int) -> bool:
    return ch == 27


def move_left(pos: int) -> int:
    return max(0, pos - 1)


def move_right(pos: int, buf_len: int) -> int:
    return min(buf_len, pos + 1)


def backspace(buf: list[str], pos: int) -> int:
    if pos > 0:
        del buf[pos - 1]
        return pos - 1
    return pos


def delete(buf: list[str], pos: int) -> int:
    if pos < len(buf):
        del buf[pos]
    return pos


def insert_char(buf: list[str], pos: int, ch: int) -> int:
    if 32 <= ch <= 126:
        buf.insert(pos, chr(ch))
        return pos + 1
    return pos


def render_line(stdscr, prompt: str, buf: list[str], pos: int) -> None:
    stdscr.move(0, 0)
    stdscr.clrtoeol()
    stdscr.addstr(0, 0, f"{prompt}{''.join(buf)}")
    stdscr.move(0, len(prompt) + pos)
    stdscr.refresh()


def handle_key(
    ch: int,
    buf: list[str],
    pos: int,
    esc_armed: bool,
) -> tuple[list[str], int, bool, bool]:
    if is_esc(ch):
        return buf, pos, False, not esc_armed

    if ch in (10, 13):
        return buf, pos, True, False

    if ch == curses.KEY_LEFT:
        return buf, move_left(pos), False, False

    if ch == curses.KEY_RIGHT:
        return buf, move_right(pos, len(buf)), False, False

    if ch in (curses.KEY_BACKSPACE, 127):
        return buf, backspace(buf, pos), False, False

    if ch == curses.KEY_DC:
        return buf, delete(buf, pos), False, False

    return buf, insert_char(buf, pos, ch), False, False


def curses_loop(stdscr, prompt: str) -> str:
    curses.curs_set(1)
    curses.start_color()
    curses.use_default_colors()

    stdscr.keypad(True)
    stdscr.bkgd(" ", curses.A_NORMAL)

    buf: list[str] = []
    pos = 0
    esc_armed = False

    render_line(stdscr, prompt, buf, pos)

    while True:
        ch = stdscr.getch()

        buf, pos, done, esc_armed = handle_key(
            ch,
            buf,
            pos,
            esc_armed,
        )

        if esc_armed and is_esc(ch):
            return EXIT_SIGNAL

        render_line(stdscr, prompt, buf, pos)

        if done:
            return "".join(buf)


def curses_input(prompt: str) -> str:
    return curses.wrapper(curses_loop, prompt)


def run(cmd, check=True):
    return subprocess.run(cmd, check=check)


def has_session(name: str) -> bool:
    result = subprocess.run(
        ["tmux", "has-session", "-t", name],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
    )
    return result.returncode == 0


def ensure_session(name: str, directory: Path | None = None) -> None:
    if not has_session(name):
        cmd = ["tmux", "new-session", "-ds", name]
        if directory:
            cmd += ["-c", str(directory)]
        run(cmd)

    run(["tmux", "switch-client", "-t", name])


def is_git_url(value: str) -> bool:
    return bool(re.match(r"^(https?://|git@[^:]+:|ssh://git@[^/]+/|gh:)", value))


def clean_repo_path(url: str) -> str:
    cleaned = re.sub(r"^ssh://git@[^/]+/", "", url)
    cleaned = re.sub(r"^git@[^:]+:", "", cleaned)
    cleaned = re.sub(r"^https?://[^/]+/", "", cleaned)
    cleaned = re.sub(r"(\.git)?$", "", cleaned)
    return cleaned


def main() -> None:
    value = curses_input("Name: ")

    if value == EXIT_SIGNAL:
        return
    if is_git_url(value):
        clean = clean_repo_path(value)
        repo_dir = SRC_DIR / clean

        if not (repo_dir / ".git").is_dir():
            repo_dir.parent.mkdir(parents=True, exist_ok=True)
            run(["git", "clone", value, str(repo_dir)])

        ensure_session(clean, repo_dir)
        return

    session_name = value
    cwd = Path.cwd()

    ensure_session(session_name, cwd)


if __name__ == "__main__":
    try:
        main()
    except subprocess.CalledProcessError as e:
        sys.exit(e.returncode)
